<!doctype html>
<html>
  <body style="font-family: Arial, sans-serif">
    <div style="margin-bottom: 8px">
      <input id="jwt" placeholder="JWT token" style="width: 420px" />
      <button onclick="connect()">Connect</button>
    </div>
    <div style="margin-bottom: 12px">
      <button onclick="flowWin()">Flow: Win</button>
      <button onclick="flowHazard()">Flow: Hazard</button>
      <button onclick="flowCashout()">Flow: CashOut</button>
    </div>
    <pre
      id="log"
      style="
        background: #111;
        color: #0f0;
        padding: 8px;
        height: 300px;
        overflow: auto;
        margin: 0;
      "
    ></pre>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      let s; // socket
      function log(m) {
        const el = document.getElementById('log');
        el.textContent += m + '\n';
        el.scrollTop = el.scrollHeight;
      }

      function connect() {
        const token = document.getElementById('jwt').value.trim();
        if (!token) {
          log('Provide JWT first');
          return;
        }
        if (s && s.connected) {
          log('Already connected');
          return;
        }
        s = io('http://localhost:3000/game', {
          auth: { token },
          transports: ['websocket'],
        });
        s.on('connect', () => log('connected ' + s.id));
        s.on('betConfig', (d) => log('betConfig ' + JSON.stringify(d)));
        s.on('game-service', (d) => log('game-service ' + JSON.stringify(d)));
        s.on('disconnect', () => log('disconnected'));
      }

      function emit(action, payload) {
        if (!s || !s.connected) {
          log('Not connected');
          return;
        }
        s.emit('game-service', { action, payload });
      }

      // Assumptions: lineNumber increments represent advancing; hazard occurs at a specific line you know.
      // You may adjust the line numbers to trigger win/hazard based on your server logic.

      // also if in the response isActive false, and isWin true, then log "Win!"
      // if isActive is false and isWin is false then log "Lose!"
      function flowEasy() {
        log('START flowEasy');
        emit('bet', { betAmount: 500, difficulty: 'easy' });

        let steps = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];
        steps.forEach((ln, i) =>
          setTimeout(() => emit('step', { lineNumber: ln }), 300 * (i + 1)),
        );
      }

      function flowHazard() {
        log('START flowHazard');
        emit('bet', { betAmount: 500, difficulty: 'easy' });
        // Simulate stepping into a hazard at line 1 (adjust if different)
        setTimeout(() => emit('step', { lineNumber: 0 }), 300);
        setTimeout(() => emit('step', { lineNumber: 1 }), 600); // assume hazard triggers here
      }

      // add two button and scripts where the flow is difficulty medium and hard,

      function flowMedium() {
        log('START flowMedium');
        emit('bet', { betAmount: 500, difficulty: 'medium' });
        // Take one safe step then cashout
        setTimeout(() => emit('step', { lineNumber: 0 }), 300);
        setTimeout(() => emit('cashout'), 600);
      }

      function flowHard() {
        log('START flowHard');
        emit('bet', { betAmount: 500, difficulty: 'hard' });
        // Take one safe step then cashout
        setTimeout(() => emit('step', { lineNumber: 0 }), 300);
        setTimeout(() => emit('cashout'), 600);
      }

      function flowCashout() {
        log('START flowCashout');
        emit('bet', { betAmount: 500, difficulty: 'easy' });
        // Take one safe step then cashout
        // cashout after 5 steps
        setTimeout(() => emit('step', { lineNumber: 0 }), 300);
        setTimeout(() => emit('cashout'), 600);
      }
    </script>
  </body>
</html>
